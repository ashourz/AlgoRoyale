import os
from pathlib import Path
from typing import Any, Optional

from algo_royale.backtester.pipeline.enums.pipeline_stage import PipelineStage
from algo_royale.backtester.pipeline.enums.data_extension import DataExtension
from algo_royale.utils.path_utils import get_data_dir

class PipelineDataManager:
    """
    A class to manage data files for different pipeline stages and strategies.
    It provides methods to read, write, update, delete, and check the existence of files.
    It also provides methods to list files in a directory and clear directories.
    """
    def __init__(self):
        self.base_dir = get_data_dir()

    def get_file_path(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension) -> Path:
        if strategy_name:
            return self.base_dir / stage.value / strategy_name / symbol / f"{filename}{extension.value}"
        # If no strategy name is provided, use the symbol as the directory
        return self.base_dir / stage.value / symbol / f"{filename}{extension.value}"

    def file_exists(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension) -> bool:
        if strategy_name:
            return self.get_file_path(stage, strategy_name, symbol, filename, extension).exists()
        # If no strategy name is provided, use the symbol as the directory
        return self.get_file_path(stage, symbol, filename, extension).exists()

    def read_file(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension, mode: str = "r") -> Optional[str]:
        if strategy_name:
            path = self.get_file_path(stage, strategy_name, symbol, filename, extension)
        else:
            # If no strategy name is provided, use the symbol as the directory
            path = self.get_file_path(stage, symbol, filename, extension)
        # Check if the file exists before trying to read it
        if not path.exists():
            return None
        with open(path, mode) as f:
            return f.read()

    def write_file(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension, data: Any, mode: str = "w") -> None:
        if strategy_name:
            path = self.get_file_path(stage, strategy_name, symbol, filename, extension)
        else:
            # If no strategy name is provided, use the symbol as the directory
            path = self.get_file_path(stage, symbol, filename, extension)
        # Ensure the directory exists
        if not path.parent.exists():
            # Create the directory if it doesn't exist
            # This will create all parent directories as well
            path.parent.mkdir(parents=True, exist_ok=True)
        # Write the data to the file
        with open(path, mode) as f:
            f.write(data)

    def update_file(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension, data: Any, mode: str = "a") -> None:
        self.write_file(stage, strategy_name, symbol, filename, extension, data, mode=mode)

    def delete_file(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str, filename: str, extension: DataExtension) -> None:
        if strategy_name:
            path = self.get_file_path(stage, strategy_name, symbol, filename, extension)
        else:
            # If no strategy name is provided, use the symbol as the directory
            path = self.get_file_path(stage, symbol, filename, extension)
        # Check if the file exists before trying to delete it
        if path.exists():
            os.remove(path)
            
    def list_files(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str) -> list:
        if strategy_name:
            path = self.get_file_path(stage, strategy_name, symbol, "", DataExtension.CSV)
        else:
            # If no strategy name is provided, use the symbol as the directory
            path = self.get_file_path(stage, symbol, "", DataExtension.CSV)
        # List all files in the directory
        return [f for f in path.parent.iterdir() if f.is_file()]    
    
    def clear_directory(self, stage: PipelineStage, strategy_name: Optional[str], symbol: str) -> None:
        if strategy_name:
            path = self.base_dir / stage.value / strategy_name / symbol
        else:
            # If no strategy name is provided, use the symbol as the directory
            path = self.base_dir / stage.value / symbol
        # Check if the directory exists before trying to clear it
        if not path.exists():
            return
        # Clear all files in the directory
        for f in path.parent.iterdir():
            if f.is_file():
                os.remove(f)
        # Optionally, remove the directory itself
        if path.parent.exists():
            os.rmdir(path.parent)
             
    def clear_all_data(self) -> None:
        # Clear all data in the base directory
        for item in self.base_dir.iterdir():
            if item.is_file():
                os.remove(item)
            elif item.is_dir():
                for f in item.iterdir():
                    if f.is_file():
                        os.remove(f)
                os.rmdir(item)
        # Optionally, remove the base directory itself
        if self.base_dir.exists():
            os.rmdir(self.base_dir)
            
            
        